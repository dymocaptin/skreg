name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  rust:
    name: Rust — test, lint, format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Clippy (deny warnings)
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        run: cargo test --workspace

  python-infra:
    name: Python infra — lint, type-check, test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra dev

      - name: ruff check
        run: uv run ruff check src/

      - name: black check
        run: uv run black --check src/

      - name: mypy
        run: uv run mypy src/

      - name: pytest
        run: uv run pytest --cov-fail-under=90

  build-push:
    name: Build and push Docker images to ECR
    needs: [rust, python-infra]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
    outputs:
      registry: ${{ steps.ecr-login.outputs.registry }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push skreg-api
        env:
          REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          SHA: ${{ github.sha }}
        run: |
          docker build \
            -f crates/skreg-api/Dockerfile \
            -t "$REGISTRY/skreg-api:$SHA" \
            -t "$REGISTRY/skreg-api:latest" \
            .
          docker push "$REGISTRY/skreg-api:$SHA"
          docker push "$REGISTRY/skreg-api:latest"

      - name: Build and push skreg-worker
        env:
          REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          SHA: ${{ github.sha }}
        run: |
          docker build \
            -f crates/skreg-worker/Dockerfile \
            -t "$REGISTRY/skreg-worker:$SHA" \
            -t "$REGISTRY/skreg-worker:latest" \
            .
          docker push "$REGISTRY/skreg-worker:$SHA"
          docker push "$REGISTRY/skreg-worker:latest"

  deploy:
    name: Deploy infrastructure with Pulumi
    needs: [build-push]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: infra
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
          aws-region: us-west-2

      - name: Install Pulumi CLI
        uses: pulumi/actions@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Pulumi up
        env:
          PULUMI_BACKEND_URL: ${{ secrets.PULUMI_BACKEND_URL }}
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
          SKILLPKG_CLOUD_PROVIDER: aws
          SKILLPKG_API_IMAGE_URI: ${{ needs.build-push.outputs.registry }}/skreg-api:${{ github.sha }}
          SKILLPKG_WORKER_IMAGE_URI: ${{ needs.build-push.outputs.registry }}/skreg-worker:${{ github.sha }}
        run: |
          pulumi stack select main
          pulumi up --yes
